---
layout: post
title: How to implement Postgre PgCrypto and migrate data to encrypted on Ruby on Rails
author: ndaru
categories: ["rails", "encryption", "postgres"]
image: https://miro.medium.com/max/1400/0*WXLKCD2VvwnaL3ET
---
<p>Secure your Personally Identifiable Information without sacrifice speed query</p><p>In Ruby on Rails there is some application level encryption like <a href="https://api.rubyonrails.org/v6.0.3/classes/ActiveSupport/MessageEncryptor.html">MessageEncryptor</a>, gemfile such as <a href="https://github.com/attr-encrypted/attr_encrypted">attr_encrypted</a>, <a href="https://github.com/ankane/lockbox">lockbox</a></p><p>The problem for application level encryption is tend difficult to search, eventually when your key or decryption process in cloud. There is another method to create another column and use hash computation since same value will return same hashed value.</p><p>PgCrypto is module provides cryptographic functions for postgreSql, it encryption level database. It supported are both symmetric-key and public-key encryption.</p><p>We try to implemented on ruby on Rails and save key into KMS platform. And migrate plain attribute into encrypted one.</p><p>We install gem<a href="https://github.com/stas/active_record-pgcrypto"> active_record-pgcrypto </a>using gem install active_record-pgcrypto .</p><p>Symmetric encryption encrypts and decrypts data using the same key and is faster than asymmetric encryption. It is the preferred method in an environment where exchanging secret keys is not an issue. With asymmetric encryption, a public key is used to encrypt data and a private key is used to decrypt data. This is slower then symmetric encryption and it requires a stronger key.</p><p>For these example, we use serializer attributes and arel API on Rails and symmetric-key encryption on postgres.</p><pre># config/initializers/pgcrypto.rb<br>require &#39;active_record/pgcrypto&#39;<br># Replace the default environment variable name with your own value/key.<br>ActiveRecord::PGCrypto::SymmetricCoder.pgcrypto_key = LOAD_FROM_KMS</pre><p>We also set initializer to load symmetric key, ensure to save key outside app like using <a href="https://docs.aws.amazon.com/sdk-for-ruby/v3/developer-guide/kms-examples.html">AWS KMS</a>, <a href="https://github.com/googleapis/google-cloud-ruby/tree/master/google-cloud-kms">Google KMS</a>, <a href="https://github.com/hashicorp/vault-ruby">Vault</a> or another third party key management service, to avoid breach key.</p><p>For further option we can also set options and encoding via:</p><pre>ActiveRecord::PGCrypto::SymmetricCoder.pgcrypto_options = &#39;cipher-algo=aes256, unicode-mode=1&#39;<br>ActiveRecord::PGCrypto::SymmetricCoder.pgcrypto_encoding = &#39;utf8&#39;</pre><p>On model we set serializer on rails and create function to search:</p><pre>class MyModel &lt; ActiveRecord::Base<br>  serialize(:email, ActiveRecord::PGCrypto::SymmetricCoder)<br><br>  def self.decrypted_email<br>    ActiveRecord::PGCrypto::SymmetricCoder<br>      .decrypted_arel_text(arel_table[:email])<br>  end<br>end</pre><p>But since is redundant and attribute to encrypted is more than one, we create metaprogramming and create concern for these one:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/3d41a7261632058728564fc24aec620c/href">https://medium.com/media/3d41a7261632058728564fc24aec620c/href</a></iframe><p>decrypted_#{attribute} will return arel query</p><pre># return Arel::Nodes::NamedFunction, it can use like Arel::Nodes::Matches</pre><pre># example User.where(User.decrypted_email.matches(&#39;raisa@random.com&#39;))</pre><pre>will return</pre><pre>&quot;SELECT \&quot;users\&quot;.* FROM \&quot;users\&quot; WHERE ENCODE(PGP_SYM_DECRYPT_BYTEA(\&quot;users\&quot;.\&quot;email\&quot;, CRYPTOGRAPHY_KEY), &#39;escape&#39;)ILIKE &#39;raisa@random.com&#39;&quot;</pre><p>Try to refactor previous model with:</p><pre>class MyModel &lt; ActiveRecord::Base<br>  include PgCryptoable</pre><pre>  attr_pgcrypto :email, :full_name, :gender<br>end</pre><p>We try to create shared example to test model which have these function</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/7c793ef8f560ea52b4f4d35e9612bb66/href">https://medium.com/media/7c793ef8f560ea52b4f4d35e9612bb66/href</a></iframe><p>and in model spec we add these spec:</p><pre>it_behaves_like &#39;pgcryptoable model&#39;</pre><pre>is_expected.to have_pgcryptoable_attribute(:email)</pre><p>For migration from plain attributes (skip if model is new)</p><p>Thats all and now database is encrypted and query search not decrease significanly</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*peAFMehWOcN12Y9xsTVQ0Q.png" /><figcaption>time consume</figcaption></figure><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/0*WXLKCD2VvwnaL3ET" /><figcaption>Photo by <a href="https://unsplash.com/@maurosbicego?utm_source=medium&amp;utm_medium=referral">Mauro Sbicego</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral">Unsplash</a></figcaption></figure><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=e09ddbce53eb" width="1" height="1">